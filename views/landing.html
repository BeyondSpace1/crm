<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CRM-RBAC</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #0a0a0a;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: white;
    display: flex;
    flex-direction: column;
  }
  nav {
    position: fixed;
    top: 0; left: 0; width: 100%;
    height: 50px;
    background: rgba(10,10,10,0.9);
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 0 20px;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);    
  }
  #login-btn {
    background: linear-gradient(45deg, #00ffff, #0066ff);
    border: none;
    color: #000;
    font-weight: bold;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    background-size: 300%;
    transition: all 0.3s ease;
  }
  #login-btn:hover {
    background: linear-gradient(45deg, #0066ff, #00ffff);
    background-size: 200%;
    background-position: right;
  }
  #canvas-container {
    position: fixed; top: 50px; left: 0; width: 100vw; height: calc(100vh - 90px);
    background-color: #fff;
    z-index: 1;
  }
  #particles-js {
    position: fixed; top: 50px; left: 0; width: 100%; height: calc(100% - 90px);
    z-index: 1;
  }
  h1.title {
    position: fixed;
    top: 70px; left: 50%; transform: translateX(-50%);
    font-size: 3rem;
    z-index: 3;
    text-align: center;
    user-select: none;
    pointer-events: none;
  }
  footer {
    position: fixed;
    bottom: 0; left: 0; width: 100%;
    height: 40px;
    background: rgba(10,10,10,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9rem;
    color: #666;
    user-select: none;
    z-index: 10;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.5);
  }
</style>
</head>
<body>

<nav>
  <div id="login-btn">Login</div>
</nav>

<h1 class="title">Welcome to the CRM</h1>

<div id="canvas-container"></div>
<div id="particles-js"></div>

<footer>
  &copy; <span id="year"></span>&nbsp;CRM-RBAC
</footer>

<!-- Libraries -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ----------- Three.js sphere --------------
const container = document.getElementById('canvas-container');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.z = 5;
const renderer = new THREE.WebGLRenderer({antialias: true});
renderer.setSize(window.innerWidth, window.innerHeight - 90);
container.appendChild(renderer.domElement);

const geometry = new THREE.IcosahedronGeometry(1, 6);
const vertexShader = `varying vec3 vNormal; void main(){ vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0); }`;
const fragmentShader = `varying vec3 vNormal; void main(){ float intensity = pow(0.5 - dot(vNormal, vec3(0,0,1.0)), 3.0); vec3 color1 = vec3(0.2,0.5,0.8); vec3 color2 = vec3(0.8,0.9,1.0); gl_FragColor = vec4(mix(color1,color2,intensity),1.0); }`;

const material = new THREE.ShaderMaterial({ vertexShader, fragmentShader, flatShading: true });
const sphere = new THREE.Mesh(geometry, material);
scene.add(sphere);

const clock = new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const time = clock.getElapsedTime();
  const pos = geometry.attributes.position;
  for(let i=0;i<pos.count;i++){
    const vx=pos.getX(i), vy=pos.getY(i), vz=pos.getZ(i);
    const len=Math.sqrt(vx*vx+vy*vy+vz*vz);
    const wave = 0.1*Math.sin(time*3+i);
    pos.setXYZ(i, (vx/len)*(1+wave), (vy/len)*(1+wave), (vz/len)*(1+wave));
  }
  pos.needsUpdate = true;
  sphere.rotation.x += 0.005 + Math.sin(time)*0.002;
  sphere.rotation.y += 0.007 + Math.cos(time)*0.003;
  renderer.render(scene,camera);
}
animate();
window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight - 90);
});

// ----------- Particles.js config --------------
particlesJS('particles-js', {
  particles: { number: {value:100}, color:{value:'#00ffff'}, shape:{type:'circle'}, opacity:{value:0.5, anim:{enable:true, speed:1, opacity_min:0.1}}, size:{value:3, random:true}, move:{enable:true, speed:2}, line_linked:{enable:true, distance:150, color:'#00ffff', opacity:0.4, width:1} },
  interactivity: { detect_on:'canvas', events:{ onhover:{enable:true,mode:'grab'}, onclick:{enable:true,mode:'push'} } },
  retina_detect:true
});

// ---------- Anime.js title ----------
anime({ targets:'.title', opacity:[0,1], duration:1500, easing:'easeInOutQuad' });

// ---------- Footer year ----------
document.getElementById('year').textContent = new Date().getFullYear();

// ---------- Login (SweetAlert2 + AJAX) ----------
// $('#login-btn').on('click',function(){
//   Swal.fire({
//     title:'Login',
//     html:`
//       <form id="swal-login-form">
//         <input id="swal-email" class="swal2-input" placeholder="Email" type="email" autocomplete="username" required />
//         <input id="swal-password" class="swal2-input" placeholder="Password" type="password" autocomplete="current-password" required />
//       </form>
//     `,
//     focusConfirm:false,
//     showCancelButton:true,
//     confirmButtonText:'Login',
//     background:'#0f172a',
//     color:'#e2e8f0',
//     preConfirm: () => {
//       const email = $('#swal-email').val();
//       const password = $('#swal-password').val();
//       if(!email || !password){ Swal.showValidationMessage('Please enter both email and password'); return false; }
//       return $.ajax({
//         url:'index.php?action=login',
//         method:'POST',
//         data:{email,password,csrf_token: CSRF_TOKEN}
//       }).then(res=>{
//         let r=res;
//         try{ if(typeof res==='string') r=JSON.parse(res); } catch(e){ Swal.showValidationMessage('Invalid server response'); return false; }
//         if(!r.success){ Swal.showValidationMessage(r.message||'Invalid credentials'); return false; }
//         return r;
//       }, ()=>{ Swal.showValidationMessage('Network error — try again'); return false; });
//     },
//     didOpen:()=>{ anime({ targets:'.swal2-popup', scale:[0.9,1], opacity:[0,1], easing:'easeOutElastic(1,.6)', duration:700 }); }
//   }).then(result=>{
//     if(result.isConfirmed && result.value && result.value.success){
//       Swal.fire({ icon:'success', title:'Welcome!', text:'Login successful. Redirecting...', timer:1200, showConfirmButton:false, willOpen:()=>{ anime({ targets:'.swal2-popup', scale:[1,1.05,1], duration:450, easing:'easeInOutQuad' }); } });
//       setTimeout(()=>window.location.href='index.php?action=dashboard',1250);
//     }
//   });
// });
let csrfToken = '';

// function fetchCsrfToken() {
//   return $.getJSON('index.php?action=get-csrf')
//     .done(res => { csrfToken = res.csrf_token; })
//     .fail(() => { console.error('Failed to fetch CSRF token'); });
// }
function fetchCsrfToken() {
  return $.getJSON('../Router.php?action=get-csrf')
    .done(res => { csrfToken = res.csrf_token; })
    .fail(() => { console.error('Failed to fetch CSRF token'); });
}


// Call this on page load
fetchCsrfToken();

$('#login-btn').on('click', function(){
  Swal.fire({
    title: 'Login',
    html: `
      <form id="swal-login-form">
        <input id="swal-email" class="swal2-input" placeholder="Email" type="email" autocomplete="username" required />
        <input id="swal-password" class="swal2-input" placeholder="Password" type="password" autocomplete="current-password" required />
      </form>
    `,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: 'Login',
    background: '#0f172a',
    color: '#e2e8f0',
    preConfirm: () => {
      const email = $('#swal-email').val();
      const password = $('#swal-password').val();
      if (!email || !password) {
        Swal.showValidationMessage('Please enter both email and password');
        return false;
      }
      return $.ajax({
        url: 'index.php?action=login',
        method: 'POST',
        data: { email, password, csrf_token: csrfToken } // ✅ include CSRF
      }).then(response => {
        let res = response;
        try { if (typeof response === 'string') res = JSON.parse(response); } catch(e) {
          Swal.showValidationMessage('Invalid server response'); return false;
        }
        if (!res.success) {
          Swal.showValidationMessage(res.message || 'Invalid credentials'); return false;
        }
        return res;
      }, () => { Swal.showValidationMessage('Network error — please try again'); return false; });
    }
  }).then(result => {
    if (result.isConfirmed && result.value && result.value.success) {
      Swal.fire({ icon: 'success', title: 'Welcome!', text: 'Login successful. Redirecting...', timer: 1200, showConfirmButton: false });
      setTimeout(() => window.location.href = 'index.php?action=dashboard', 1250);
    }
  });
});

</script>
</body>
</html>
